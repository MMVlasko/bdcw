@startuml

entity users {
  * id : BIGSERIAL <<PK>>
  --
  username : VARCHAR(50) <<UNIQUE>> <<NOT NULL>>
  password_hash : VARCHAR(255) <<NOT NULL>>
  first_name : VARCHAR(50)
  last_name : VARCHAR(50)
  description : TEXT
  role: user_role
  is_active : BOOLEAN <<DEFAULT true>>
  is_public : BOOLEAN <<DEFAULT true>>
  created_at : TIMESTAMP <<NOT NULL>> <<DEFAULT NOW()>>
  updated_at : TIMESTAMP <<NOT NULL>> <<DEFAULT NOW()>>
}

entity auth_tokens {
  * key : VARCHAR(64) <<NOT NULL>> <<PK>>
  --
  created_at : TIMESTAMP <<NOT NULL>> <<DEFAULT NOW()>>
  expires_at : TIMESTAMP <<NOT NULL>>
  is_active : BOOLEAN <<NOT NULL>>
  user_id : BIGINTEGER <<FK>>
}

entity goals {
  * id : BIGSERIAL <<PK>>
  --
  user_id : BIGINTEGER <<FK>>
  title : VARCHAR(255) <<NOT NULL>>
  description : TEXT
  category_id : BIGINTEGER <<FK>>
  target_value : NUMERIC(10, 3) <<NOT NULL>>
  deadline : DATE <<NOT NULL>>
  is_completed : BOOLEAN <<DEFAULT false>>
  is_public : BOOLEAN <<DEFAULT true>>
  created_at : TIMESTAMP <<NOT NULL>> <<DEFAULT NOW()>>
  updated_at : TIMESTAMP <<NOT NULL>> <<DEFAULT NOW()>>
}

entity habits {
  * id : BIGSERIAL <<PK>>
  --
  user_id : BIGINTEGER <<FK>>
  title : VARCHAR(255) <<NOT NULL>>
  description : TEXT
  category_id : BIGINTEGER <<FK>>
  frequency_type : INTEGER > 0
  frequency_value : INTEGER > 0
  is_active : BOOLEAN <<DEFAULT true>>
  is_public : BOOLEAN <<DEFAULT true>>
  created_at : TIMESTAMP <<NOT NULL>> <<DEFAULT NOW()>>
  updated_at : TIMESTAMP <<NOT NULL>> <<DEFAULT NOW()>>
}

entity categories {
  * id : BIGSERIAL <<PK>>
  --
  name : VARCHAR(100) <<UNIQUE>> <<NOT NULL>>
  description : TEXT
  created_at : TIMESTAMP <<NOT NULL>> <<DEFAULT NOW()>>
  updated_at : TIMESTAMP <<NOT NULL>> <<DEFAULT NOW()>>
}

entity habit_logs {
  * id : BIGSERIAL <<PK>>
  --
  habit_id : BIGINTEGER <<FK>>
  log_date : DATE <<NOT NULL>> <<DEFAULT CURRENT_DATE>>
  status : VARCHAR(20) <<CHECK>> <<NOT NULL>>
  notes : TEXT
  created_at : TIMESTAMP <<NOT NULL>> <<DEFAULT NOW()>>
  updated_at : TIMESTAMP <<NOT NULL>> <<DEFAULT NOW()>>
}

entity goal_progresses {
  * id : BIGSERIAL <<PK>>
  --
  goal_id : BIGINTEGER <<FK>>
  progress_date : DATE <<NOT NULL>>
  current_value : NUMERIC <<NOT NULL>>
  notes : TEXT
  created_at : TIMESTAMP <<NOT NULL>> <<DEFAULT NOW()>>
  updated_at : TIMESTAMP <<NOT NULL>> <<DEFAULT NOW()>>
}

entity challenges {
  * id : BIGSERIAL <<PK>>
  --
  name : VARCHAR(255) <<NOT NULL>>
  description : TEXT
  target_value : NUMERIC
  start_date : DATE <<NOT NULL>>
  end_date : DATE <<NOT NULL>>
  is_active : BOOLEAN <<DEFAULT true>>
}

entity challenge_categories {
  * challenge_id : BIGINTEGER <<PK>> <<FK>>
  * category_id : BIGINTEGER <<PK>> <<FK>>
}

entity goal_challenges {
  * goal_id : BIGINTEGER <<PK>> <<FK>>
  * challenge_id : BIGINTEGER <<PK>> <<FK>>
  --
  joined_at : TIMESTAMP <<NOT NULL>> <<DEFAULT NOW()>>
}

entity subscriptions {
  * subscriber_id : BIGINTEGER <<PK>> <<FK>>
  * subscribing_id : BIGINTEGER <<PK>> <<FK>>
  --
  subscribed_at : TIMESTAMP <<NOT NULL>> <<DEFAULT NOW()>>
}

entity audit_logs {
  * id : BIGSERIAL <<PK>>
  --
  table_name : VARCHAR(100) <<NOT NULL>>
  record_id : BIGINTEGER
  operation : VARCHAR(10) <<CHECK>> <<NOT NULL>>
  old_values : JSONB
  new_values : JSONB
  changed_by_id : BIGINTEGER <<FK>>
  changed_at : TIMESTAMP <<NOT NULL>> <<DEFAULT NOW()>>
}

entity batch_logs {
  * id : BIGSERIAL <<PK>>
  --
  table_name : VARCHAR(100) <<NOT NULL>>
  total_processed : INTEGER
  successful : INTEGER
  failed : INTEGER
  errors : JSONB
  created_ids : INTEGER[]
  batches_processed : INTEGER
  batch_size : INTEGER
  changed_by_id : BIGINTEGER <<FK>>
  created_at : TIMESTAMP <<NOT NULL>> <<DEFAULT NOW()>>
}

goals  "0..n" --^ "1                        "  users  : " user_id:id"
habits    "0..n    \n" --^ "1       "  users  : "    user_id:id"
auth_tokens    "0..n  " --^ "1    \n"  users  : " user_id:id"
goals    "     0..1   " --^ "1     \n"  categories : " category_id:id  "
habits     "     0..1       " --^ "1   "  categories : "category_id:id  "
goal_progresses  "0..n   " --^ "1   "  goals  : "  goal_id:id"
habit_logs    "0..n   " --^ "1   \n"  habits  : "  habit_id:id   \n"
challenge_categories    "0..n " --^ "1      "  challenges : " challenge_id:id  "
challenge_categories     "0..n   " --^ "1\n"  categories : "category_id:id "
goal_challenges    "0..n     " --^ "1      "  challenges : " challenge_id:id  "
goal_challenges     "0..n " --^ "       1"  goals : " user_id:id  "
subscriptions   "0..n     " --^ "1     \n "  users : " subscriber_id:id  "
subscriptions    "0..n          " --^ " 1     "  users : " subscribing_id:id  "
audit_logs    "0..n             " --^ " 1     \n"  users : " changed_by_id:id  "
batch_logs    "0..n        " --^ " 1     \n"  users : " changed_by_id:id  "
@enduml